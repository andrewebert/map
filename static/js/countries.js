// Generated by CoffeeScript 1.7.1
app.directive('countries', function() {
  return function($scope) {
    var attr, attrs, changed, code, countries, country, curr, data, date, i, last_time, old, prev, time, _i, _j, _len, _len1, _ref, _ref1, _ref2, _ref3;
    $scope.flags = {};
    attrs = ["d", "name", "formal", "flag", "link", "description", "fill", "removed", "code"];
    last_time = $scope.times.length - 1;
    countries = {};
    countries[last_time] = {};
    for (country in initial_countries) {
      data = initial_countries[country];
      countries[last_time][country] = data;
    }
    prev = countries[last_time];
    _ref = $scope.times.slice(1);
    for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
      date = _ref[i];
      time = $scope.times.length - i - 2;
      if (changes[date] != null) {
        curr = {};
        for (code in prev) {
          old = prev[code];
          curr[code] = old;
        }
        _ref1 = changes[date];
        for (code in _ref1) {
          changed = _ref1[code];
          if (curr[code] != null) {
            curr[code] = {};
            for (_j = 0, _len1 = attrs.length; _j < _len1; _j++) {
              attr = attrs[_j];
              curr[code][attr] = (_ref2 = (_ref3 = changed[attr]) != null ? _ref3 : prev[code][attr]) != null ? _ref2 : "";
              if (curr[code][attr] === "-") {
                curr[code][attr] = "";
              }
            }
          } else {
            curr[code] = changed;
          }
        }
        countries[time] = curr;
        prev = curr;
        last_time = time;
      } else {
        countries[time] = countries[last_time];
      }
    }
    $scope.data = countries;
    return $scope.load_image = function(src, on_load) {
      var image;
      if (src == null) {
        console.log("image load error");
        return;
      }
      image = new Image();
      image.src = src;
      image.onload = function() {
        return on_load(src, image);
      };
      return image.onerror = function() {
        return on_load(src, image);
      };
    };
  };
});
